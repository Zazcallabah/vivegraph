<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>

body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  margin: auto;
  position: relative;
  width: 960px;
}

text {
  font: 10px sans-serif;
}

li { display: inline-block; }

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.d3-tip {
  line-height: 1;
  font-weight: bold;
  padding: 12px;
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  border-radius: 2px;
}

/* Creates a small triangle extender for the tooltip */
.d3-tip:after {
  box-sizing: border-box;
  display: inline;
  font-size: 10px;
  width: 100%;
  line-height: 1;
  color: rgba(0, 0, 0, 0.8);
  content: "\25BC";
  position: absolute;
  text-align: center;
}

/* Style northward tooltips differently */
.d3-tip.n:after {
  margin: -1px 0 0 0;
  top: 100%;
  left: 0;
}
.stroke {
	text-shadow:
	-1px -1px 0 #fff,
	1px -1px 0 #fff,
	-1px 1px 0 #fff,
	1px 1px 0 #fff;  
}

</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.0/knockout-min.js"></script>
<script src="d3.v3.min.js"></script>
</head>
<body>
<ul data-bind="foreach: locations">
	<li><label><input type="checkbox" data-bind="checked: selected" ><span data-bind="text:label"></span></label></li>
</ul>
<label><input type="checkbox" data-bind="checked: all" >Select all</label>
<script>
var LocationModel = function( str ){
	this.label = str;
	this.selected = ko.observable(true);
	this.selected.extend({ rateLimit: 50 })
	this.selected.subscribe(function(newValue) {
		redraw();
	});
};

var regionModel = {
	locations: ko.observableArray([new LocationModel("None")]),
	all: ko.observable(true),
	updating: false
};

regionModel.all.subscribe(function(newValue) {
updating=true;
	regionModel.locations().forEach( function(l){ l.selected(newValue);});
updating=false;
		redraw();
	});
function sortNum(a,b) {
	return a - b;
}

function sortStr(a,b){
	return a.localeCompare(b);
}


function transform2xyNumericX( data ) {
	var res = { x: +data.key, y: data.values }
	return res;
}

function transform2xy( data ) {
	var res = { x: data.key, y: data.values }
	return res;
}



//var jsonsource = 'reddit_users.json';
var jsonsource = 'https://vive.lol/data/reddit_users.json'
var jsondata = {};

d3.json(jsonsource, function(jd) { 
	jsondata = jd;
	
	var unique = {};
	var distinct = [];
	var i = 0;
	jd.forEach(function (x) {
		var loc = x.location;
		if ( loc != undefined && !unique[loc]) {
			regionModel.locations.push(new LocationModel(loc));
			unique[loc] = true;
		}
	});
	
	regionModel.locations.sort(function sortStr(a,b){
	return a.label.localeCompare(b.label);
});
	redraw();
});

function d3rollup( data, key, filter, transform ) {
	return d3.nest()
		.key( key )
		.rollup( function(d) { return d3.sum( d, filter ) } )
		.entries( data )
		.map( transform || transform2xy );
}

function addMissingEntries( range, data ) {
	return range.map( function(r){
		var filtered = data.filter( function(d){ return d.x==r; } );
		if( filtered.length > 0 )
			return filtered[0];
		else
			return { x:r, y:0 };
	});
}
	var margin = {top: 40, right: 10, bottom: 30, left: 35},
		width = 960 - margin.left - margin.right,
		height = 500 - margin.top - margin.bottom;

function addChartSvg() {
	return d3.select("body").append("svg")
			.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom);
}

function redrawChart( svg, dataset, colors, x_label, y_label ){
	svg.selectAll("*").remove();
	var stack = d3.layout.stack();
	
	var layers = stack(dataset);
	var y_max = d3.max(layers, function(layer) { return d3.max(layer, function(d) { return d.y0 + d.y; }); });

	var x = d3.scale.ordinal().rangeRoundBands([0, width], .08);
	
	var xdomaindata = dataset.reduce(function(d1,d2){ return d1.concat(d2) },[]);
	x.domain(xdomaindata.map(function(d) { return d.x; }));

	var y = d3.scale.linear()
		.domain([0, y_max])
		.range([height, 0]);


	var xAxis = d3.svg.axis()
		.scale(x)
		.tickSize(3)
		.tickPadding(6)
		.orient("bottom")
		.tickFormat("");

	var yAxis = d3.svg.axis()
		.scale(y)
		.tickSize(0)
		.tickPadding(6)
		.orient("left");

	var svg_g = svg.append("g")
		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	var layer = svg_g.selectAll(".layer")
		.data(layers)
		.enter().append("g")
		.attr("class", "layer")
		.style("fill", function(d, i) { return colors[i]; });
		
	var rect_enter = layer.selectAll("rect")
		.data(function(d) { return d; })
		.enter();
	var rect = rect_enter.append("rect")
		.attr("x", function(d) { return x(d.x); })
		.attr("y", height)
		.attr("width", x.rangeBand())
		.attr("height", 0);
		
	rect_enter.append("text")
		.attr("x", function(d) { return x(d.x); })
		.attr("y", function(d) { return y(d.y0) - y(d.y0 + d.y); })
		.text(function(d,i){ return d.x; })
	//		.attr("transform", "rotate(90)")
//			.style("text-anchor", "start")
			.classed("stroke", true)
		;
		
	rect.transition()
		.delay(function(d, i) { return i * 10; })
		.attr("y", function(d) { return y(d.y0 + d.y); })
		.attr("height", function(d) { return y(d.y0) - y(d.y0 + d.y); });

	svg_g.append("g")
		.attr("class", "x axis")
		.attr("transform", "translate(0," + height + ")")
		.call(xAxis);

		svg_g.append("g")
		.attr("class", "y axis")
		.call(yAxis);

	svg_g.append("text")
		.attr("text-anchor", "middle")
		.attr("transform", "translate(-25,"+(height/2)+")rotate(-90)") 
		.text(y_label);

	svg_g.append("text")
		.attr("text-anchor", "middle")
		.attr("transform", "translate("+ (width/2) +","+(height+25)+")")
		.text(x_label);

}

function _filter( sourcefilter, keyselector, sumfilter ){
	return {
		source: sourcefilter,
		key: keyselector,
		sum: sumfilter
	};
};


/// filters
function wrongLocation( data ) {
	var cmploc = (data.location!=undefined) ? data.location : "None";
	var loc = regionModel.locations().filter(function(l){	return l.label == cmploc;});
	if( loc.length == 1)
	{
		if( !(loc[0].selected()) )
			return true;
	}
	else throw "invalid location";
	return false;
}
function includeFirstHourOrders( data ) {
	if( wrongLocation( data ) )
		return false;
	return data.preorder_minutes != undefined;
}

function excludeFirstHourOrders( data ) {
	if( wrongLocation( data ) )
		return false;
	return data.preorder_minutes == undefined;
}

function includePreorderDate( data ) {
	return data.preorder_date != undefined && excludeFirstHourOrders(data);
}

function preorderMinutes( d ) {
	return d.preorder_minutes;
};

function preorderDate( d ) {
	return d.preorder_date;
};
function shippedUndefSum( d ) {
	return d.shipped == undefined ? 1 : 0;
};

function shippedSum( d ) {
	return (d.shipped != undefined && d.shipped) ? 1 : 0; 
}

function notShippedSum( d ) {
	return (d.shipped != undefined && !d.shipped) ? 1 : 0;
}

function sortRollupLabel(a,b){
	return a.x.localeCompare(b.x);
}

function filterRollup( filter ) {
	return d3rollup(
		jsondata.filter( filter.source ),
		filter.key,
		filter.sum
	).sort( sortRollupLabel );
}
function filterRollupNumeric( filter ) {
	return d3rollup(
		jsondata.filter( filter.source ),
		filter.key,
		filter.sum,
		transform2xyNumericX
	);
}
var chart1 = addChartSvg();
var chart2 = addChartSvg();


function redraw() {
	if( regionModel.updating )
		return;
		
	var filters = [
		_filter( includeFirstHourOrders,preorderMinutes,shippedUndefSum ),
		_filter( includeFirstHourOrders,preorderMinutes,shippedSum ),
		_filter( includeFirstHourOrders,preorderMinutes,notShippedSum )
	];
	var dataset = filters.map( filterRollupNumeric );

	var colors = ["#aaa","#0a0", "#a00"];
	
	redrawChart( chart1, dataset, colors, "Minutes past XX:00 - Red: not shipped, Green: shipped, Gray: no info", "Number of orders", true );
	
	var filters = [
		_filter( includePreorderDate,preorderDate,shippedUndefSum ),
		_filter(  includePreorderDate,preorderDate,shippedSum ),
		_filter(  includePreorderDate,preorderDate,notShippedSum )
	];
	var dataset = filters.map( filterRollup );
	redrawChart( chart2,dataset, colors, "Preorder date - Red: not shipped, Green: shipped, Gray: no info", "Number of orders, excluding first hour orders" );
}
ko.applyBindings(regionModel);

</script>
<ul>
	<li><a href="https://vive.lol">vive.lol</a></li>
	<li><a href="https://github.com/Zazcallabah/vivegraph">source</a></li>
</ul>

</body></html>