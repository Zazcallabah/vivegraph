<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>

body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  margin: auto;
  position: relative;
  width: 960px;
}

text {
  font: 10px sans-serif;
}

.side { font: 0.6em; }
.compact { display: inline-block}
.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.stroke {
	text-shadow:
	-1px -1px 0 #fff,
	1px -1px 0 #fff,
	-1px 1px 0 #fff,
	1px 1px 0 #fff;  
}

</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.0/knockout-min.js"></script>
<script src="d3.v3.min.js"></script>
</head>
<body>
<div class="side">
<label><input type="checkbox" id="toggleAll" data-bind="click: toggleAll" checked>Toggle all</label>
<ul data-bind="foreach: locationGroups">
	<li>
		<span data-bind="text: name"></span>: <label><input type="checkbox" data-bind="attr:{id: name}, click: checked" checked >All</label>
		<ul data-bind="foreach: entries">
			<li class="compact"><label><input type="checkbox" data-bind="attr:{ id: $data }, click: $root.delayedRedraw" checked><span data-bind="text:$data"></span></label></li>
</ul>
	</li>
</ul>
</div>



<p>3/29<input style="width:300px" type="range" oninput="onRangeInput(this.value)" 
data-bind="attr: {min: 1459209600000, max: maxvalue}, value: datefilter"  />today<br><span data-bind="text: dateval"></span></p>

<script>
var Group = function( name, entries ){
	this.name = name;
	this.entries = entries;
};
Group.prototype.setAll = function(val){
	this.entries.forEach(function(e){
		document.getElementById(e).checked = val;
	});
};
Group.prototype.checked = function(){
	this.setAll(document.getElementById(this.name).checked);
	regionModel.delayedRedraw();
	return true;
};

function onRangeInput( value ){
	regionModel.datefilter(value);
	regionModel.delayedRedraw();
};
var RegionModel = function(){

	this.locationGroups = [
		new Group("Other", ["None","AU","NZ","CN","JP","TW"] ),
		new Group("United States",["US","US-AK","US-AL","US-AR","US-AZ","US-CA","US-CO","US-CT","US-DC","US-DE","US-FL","US-GA","US-HI","US-IA","US-ID","US-IL","US-IN","US-KS","US-KY",
			"US-LA","US-MA","US-MD","US-ME","US-MI","US-MN","US-MO","US-MS","US-MT","US-NC","US-ND","US-NE","US-NH","US-NJ","US-NM","US-NV","US-NY","US-OH",
			"US-OK","US-OR","US-PA","US-PR","US-RI","US-SC","US-SD","US-TN","US-TX","US-UT","US-VA","US-VT","US-WA","US-WI","US-WV","US-WY"] ),
		new Group("Canada", ["CA","CA-AB","CA-BC","CA-MB","CA-NB","CA-NL","CA-NT","CA-NS","CA-NU","CA-ON","CA-PE","CA-QC","CA-SK","CA-YT"] ),
		new Group("Europe", ["AT","BE","CH","CZ","DE","DK","ES","FI","FR","IE","IS","IT","NL","NO","PL","SE","UK"])
	];

	var currentDatePlusSome = new Date().getTime()+100000000
	this.locations = {};
	this.datefilter = ko.observable(currentDatePlusSome);
	this.dateval = ko.observable(" ");
	this.maxvalue = currentDatePlusSome;
	this.delayActive=false;
};
RegionModel.prototype.toggleAll = function(){
	var val = document.getElementById("toggleAll").checked;
	this.locationGroups.forEach( function(g){
		document.getElementById(g.name).checked = val;
		g.setAll( val );
	});
	this.delayedRedraw();
	return true;
};
RegionModel.prototype.delayedRedraw = function(slidervalue){
	if( !jsondata.filter )
		return true;
	var that = regionModel;
	if( that.delayActive )
		return true;
	that.delayActive = true;
	setTimeout(function(){
		redraw();
		that.delayActive=false;
	},100);
	return true;
};
window.onload = function(){
	var loc = window.location.hash.substring(1);
	if( loc && loc.length > 0 )
	{
		document.getElementById("toggleAll").checked = false;
		regionModel.toggleAll();
		var em = document.getElementById(loc);
		if( em )
			em.checked = true;
		
	}
};
var regionModel = new RegionModel();
function updateLocations(){
	var l = {};
	regionModel.locationGroups.forEach(function(g){
		g.entries.forEach(function(e){
			l[e]=document.getElementById(e).checked;
		});
	});
	regionModel.locations = l;
};
regionModel.datefilter.subscribe(function(s){
	var v = parseInt(s,10);
	regionModel.dateval( new Date(v).toISOString().slice(0, 10));
	});
function sortNum(a,b) {
	return a - b;
}

function sortStr(a,b){
	return a.localeCompare(b);
}


function sortDynamic(a,b){
	if( isNaN(a) )
		return sortStr(a,b);
	else
		return sortNum(parseInt(a,10), parseInt(b,10));
}

function transform2xy( data ) {
	var res = { x: data.key, y: data.values }
	return res;
}



//var jsonsource = 'reddit_users.json';
var jsonsource = 'https://vive.lol/data/reddit_users.json';
var jsondata = {};

d3.json(jsonsource, function(jd) { 
	jsondata = jd;
	regionModel.delayedRedraw();
});

	var margin = {top: 40, right: 10, bottom: 100, left: 45},
		width = 960 - margin.left - margin.right,
		height = 560 - margin.top - margin.bottom;

function addChartSvg() {
	return d3.select("body").append("svg")
			.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom);
}

function redrawChart( svg, dataset, colors, x_label, y_label ){
	svg.selectAll("*").remove();
	var stack = d3.layout.stack();
	
	var x_domain = [];
	
	dataset.forEach( function(s){
		s.forEach( function(d){
			if( x_domain.filter( function(e){ return e === d.x; } ).length == 0 )
				x_domain.push(d.x);
		});
	});
	
	x_domain.sort( sortDynamic );

	var layers = stack(dataset);
	var y_max = d3.max(layers, function(layer) { return d3.max(layer, function(d) { return d.y0 + d.y; }); });

	var x = d3.scale.ordinal()
		.domain(x_domain)
		.rangeRoundBands([0, width], .08);

	var y = d3.scale.linear()
		.domain([0, y_max])
		.range([height, 0]);


	var xAxis = d3.svg.axis()
		.scale(x)
		.tickSize(3)
		.tickPadding(6)
		.orient("bottom");

	var yAxis = d3.svg.axis()
		.scale(y)
		.tickSize(0)
		.tickPadding(6)
		.orient("left");

	var svg_g = svg.append("g")
		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	var layer = svg_g.selectAll(".layer")
		.data(layers)
		.enter().append("g")
		.attr("class", "layer")
		.style("fill", function(d, i) { return colors[i]; });
		
	var rect = layer.selectAll("rect")
		.data(function(d) { return d; })
		.enter().append("rect")
		.attr("x", function(d) { 
			return x(d.x); 
		})
		.attr("y", function(d) { return y(d.y0 + d.y); })
		.attr("height", function(d) { return y(d.y0) - y(d.y0 + d.y); })
	.attr("width", x.rangeBand());


	var xAxisElement = svg_g.append("g")
		.attr("class", "x axis")
		.attr("transform", "translate(0," + height + ")")
		.call(xAxis);
	xAxisElement.selectAll("text")
		.attr("y", 0)
		.attr("x", 9)
		.attr("dy", ".35em")
		.attr("transform", "rotate(90)")
		.style("text-anchor", "start");

		var labeldistance = xAxisElement.node().firstChild.getBBox().height;
	
	svg_g.append("g")
		.attr("class", "y axis")
		.call(yAxis);

	svg_g.append("text")
		.attr("text-anchor", "middle")
		.attr("transform", "translate(-30,"+(height/2)+")rotate(-90)") 
		.text(y_label);

	svg_g.append("text")
		.attr("text-anchor", "middle")
		.attr("transform", "translate("+ (width/2) +","+(height+20+labeldistance)+")")
		.text(x_label);

}

function _filter( sourcefilter, keyselector, sumfilter ){
	return {
		source: sourcefilter,
		key: keyselector,
		sum: sumfilter
	};
};


/// filters
function wrongLocation( data ) {
	var cmploc = (data.location!=undefined) ? data.location : "None";
	var loc = regionModel.locations[cmploc];
	if( loc === undefined || !loc)
	{
			return true;
	}
	return false;
}
function includeFirstHourOrders( data ) {
	if( wrongLocation( data ) )
		return false;
	return data.preorder_minutes != undefined;
}

function excludeFirstHourOrders( data ) {
	if( wrongLocation( data ) )
		return false;
	return data.preorder_minutes == undefined;
}

function includePreorderDate( data ) {
	return data.preorder_date != undefined && excludeFirstHourOrders(data);
}

function preorderMinutes( d ) {
	return d.preorder_minutes;
};

function preorderDate( d ) {
	return d.preorder_date;
};
function shippedUndefSum( d ) {
	return d.shipped === undefined ? 1 : 0;
};

function shippedSum( d ) {
	if( d.shipped === undefined )
		return 0;
	if( !d.shipped )
		return 0;
	var m = d.earliest_shipped_report;
	if( m > regionModel.datefilter()/1000 )
		return 0;
	return 1;
}

function notShippedSum( d ) {
	if( d.shipped === undefined )
		return 0;
	if( !d.shipped )
		return 1;
	var m = d.earliest_shipped_report;
	if( m > regionModel.datefilter()/1000 )
		return 1;
	return 0;
}

function includeShipped( data ){
	if( wrongLocation( data ) )
		return false;
	return data.shipped;
};


function earliestShippedReport(d){
	return new Date( d.earliest_shipped_report * 1000 ).toISOString().slice(0, 10);
};

function shippedAll( d ) {
	return 1;
};

function d3rollup( data, key, filter ) {
	return d3.nest()
		.key( key )
		.rollup( function(d) { return d3.sum( d, filter ) } )
		.entries( data )
		.map( transform2xy );
}

function filterRollup( filter ) {
	return d3rollup(
		jsondata.filter( filter.source ),
		filter.key,
		filter.sum
	);
}

var chart1 = addChartSvg();
var chart2 = addChartSvg();
var chart3 = addChartSvg();


function redraw() {
		updateLocations();
	var filters = [
		_filter( includeFirstHourOrders,preorderMinutes,shippedUndefSum ),
		_filter( includeFirstHourOrders,preorderMinutes,shippedSum ),
		_filter( includeFirstHourOrders,preorderMinutes,notShippedSum )
	];
	var dataset = filters.map( filterRollup );

	var colors = ["#aaa","#0a0", "#a00"];
	
	redrawChart( chart1, dataset, colors, "Minutes past XX:00 - Red: not shipped, Green: shipped, Gray: no info", "Number of orders" );
	
	var filters = [
		_filter( includePreorderDate,preorderDate,shippedUndefSum ),
		_filter(  includePreorderDate,preorderDate,shippedSum ),
		_filter(  includePreorderDate,preorderDate,notShippedSum )
	];
	var dataset = filters.map( filterRollup );
	redrawChart( chart2,dataset, colors, "Preorder date - Red: not shipped, Green: shipped, Gray: no info", "Number of orders, excluding first hour orders" );
	
	var filters = [ _filter( includeShipped,earliestShippedReport,shippedAll ) ];

	redrawChart(
		chart3,
		filters.map( filterRollup ),
		["darkblue"],
		"Date",
		"Number of shipped units" );
}
ko.applyBindings(regionModel);

</script>
<ul>
	<li><a href="https://vive.lol">vive.lol</a></li>
	<li><a href="https://github.com/Zazcallabah/vivegraph">source</a></li>
</ul>

</body></html>
